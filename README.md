# skycoin-modal

WIP skycoin payment modal web application for integration with snipcart.com as a custom payment gateway


Tested on Archlinux

## Prerequisite

```
yay -S go hugo skycoin-explorer skycoin-bin
```
Note: the skycoin explorer will be added to the [.deb package repo](https://the-sycoin-project.github.io) soon.

Additional optional dependencies
```
yay -S privateness bitcoind nbxplorer btcpayserver
```
Note: nbxplorer and btcpayserver fail to build currently, while a full bitcoin node may take up to 2 months to sync initially.

To live reload the application you will need:
```
go get github.com/pilu/fresh
sudo ln -s ~/go/bin/fresh /usr/bin/fresh
```
(Alternatively, you can add GOBIN to your PATH)

## Sync Go Dependencies

Sync the needed golang dependencies
```
go mod init
go mod vendor -v
```

## Build the Frontend with Hugo

Hugo is used to generate the html templates and page resources

**The escaped functions (which need to appear in the final template files generated by hugo) are defined in [config.toml](/config.toml)**

Build the front end
```
hugo -D
```

Live-editing the hugo templates is also possible, this is done independent of the golang web application.
```
hugo server -D
```

## Build or update the statik/statik.go file

requires the statik binary:
```
go get github.com/rakyll/statik
sudo ln -s ~/go/bin/statik /usr/bin/statik
```

generate the statik/statik.go file from the public dir which was generated by hugo above
```
statik -f -src=./public
```

updates the dependencies according to the above generated file
```
go generate
```

the contents of the `public` folder which was created by hugo in the previous step can now be compiled into the binary.


## Run the application
Note: to fully utilize this application you must run a skycoin node and an instance of the skycoin-explorer and complete some additional configuration. See below.
```
make fresh
```

starts on :
[http://127.0.0.1:8041](http://127.0.0.1:8041)

Non-breaking changes to the source code in main.go will be refreshed automatically.

## Building the binary

Note the contents of the Makefile and the envs required to run this. The configuration in this regard will be improved in the future. The instance used for development has some values hard-coded, these must be changed to ENVs or a configuration file scheme must be devised or a mechanism for prompting for user input to create such a configuration.

Any binary release provided here will be compiled statically with musl, for good measure and not because I am actually aware of glibc dependency here.

A simple `go build .` should suffice if you desire to compile a binary, assuming that statik/statik.go is present

## Production deployment

In the author's test environment, `caddy` server is used to reverse proxy the app port (8041) to a subdomain of the main website.

example Caddyfile:
```
example.net {
reverse_proxy 127.0.0.1:8040
}
pay.example.net {
reverse_proxy 127.0.0.1:8041
}
btc.example.net {
reverse_proxy 127.0.0.1:23000
}
skycoin.example.net {
reverse_proxy 127.0.0.1:8001
}
ness.example.net {
reverse_proxy 127.0.0.1:8002
}
```

The above defined endpoints correspond to the following:

`pay.example.net`  payment modal / web app
`btc.example.net`  BTCPayServer instance
`skycoin.example.net`  skycoin explorer
`ness.example.net`    privateness explorer

Note: it is not required to have the privateness or skycoin explorers on their own subdomain, only running on the same machine.

## Snipcart Integration

In the payment methods request URL field of the [snipcart dashboard](https://app.snipcart.com/dashboard/account/gateway/customgateway) the following endpoint is specified:
```
https://pay.example.com/paywithskycoin
```

When placing an order; after the customer enters their shipping information and selects a shipping option, snipcart makes a POST request to the endpoint above, specified in the merchant dashboard. After verifying the request, a response is sent which is an array of payment options (an array of 1 but it can be more than one).

The array of payment option is then displayed for the customer, the previously configured ones in the merchant dashboard, as well as any which are specified in main.go, for this example only skycoin is shown.

## Generate Addresses

To display the correct addresses for your webstore, these addresses must be generated and defined in addresses.txt in the current working directory.

**NOTE: Do not have the wallet with the coins in the same environment or on the same machine as this for obvious security reasons**

Create the wallet addresses in a secure environment (using the wallet gui is most functional), create 100 addresses and export them to a file:
```
skycoin-cli listWallets
skycoin-cli listAddresses 2021_04_20_7ba7.wlt > sky-addresses.txt
```

NOTE FOR PRIVATENESS: the privateness-cli is glitchy at the moment, so save your wallet in your skycoin wallet dir and use skycoin-cli after opening the wallet in the GUI. (The addresses will be the same) save the json-formatted list of addresses output by skycoin-cli to `ness-addresses.txt`

Save these addresses somewhere in case you need to manually recover them.

Copy them to this repository in your test environment.

## Run a skycoin node

A gui instance of the skycoin wallet will suffice, but it **MUST NOT CONTAIN ANY COINS**

this is merely a runtimedependency of the skycoin explorer

You may use a hardware wallet or any single address quotated in place of the `nextAddress()` function.

I am unaware of how to create addresses with the hardware wallet. It may be possible with cli but it is not possible with the gui.

If using a single address you do not require to run a skycoin node or the skycoin explorer.

## Run the skycoin explorer

An archive of a working copy of the skycoin explorer for linux is provided.

Extract it somewhere, and from in that directory you can run the skycoin explorer with:

```
bin/skycoin-explorer
```

make sure your skycoin node is running on the default port :6420


## Run a Privateness Node

if using the AUR package
```
ness-wallet
```

the above section pertaining to skycoin still applies


## TO DO

Revise GUI / branding to exactly match per crypto and remove any unnecessary scripts

Autodetect payment and redirect / remove txid entry

## Simultaneous Support for Fibercoins

The ness-explorer is included in the release section
