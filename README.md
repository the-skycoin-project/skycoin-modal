# skycoin-modal

WIP skycoin payment modal / web application for integration with snipcart.com as a custom payment gateway.

Developed and Tested on Archlinux

## Prerequisite

```
yay -S go hugo skycoin-explorer skycoin-bin
```
Note: the skycoin explorer will be added to the [.deb package repo](https://the-sycoin-project.github.io) soon.

Additionally, to live reload the application you will need:
```
go get github.com/pilu/fresh
sudo ln -s ~/go/bin/fresh /usr/bin/fresh
```

(Alternatively, you can add GOBIN to your PATH)

## Sync Dependencies

Sync the needed golang dependencies
```
go mod init
go mod vendor -v
```

## Build the Frontend with Hugo

Hugo is used to generate the html templates and page resources

**The escaped functions (which need to appear in the final template files generated by hugo) are defined in [config.toml](/config.toml)**

Build the front end
```
hugo -D
```

Live-editing the hugo templates is also possible, this is done independent of the golang web application.

```
hugo server -D
```

## Build the statik/statik.go file
(requires the statik binary)
```
go get github.com/rakyll/statik
sudo ln -s ~/go/bin/statik /usr/bin/statik
```

generate the statik/statik.go file from the public dir which was generated by hugo above
```
statik -src=./public
```

updates the dependencies according to the above generated file
```
go generate
```

the contents of the `public` folder which was created by hugo in the previous step can now be compiled into the binary.


## Run the application
```
make fresh
```

starts on :
[http://127.0.0.1:8041](http://127.0.0.1:8041)


## Production deployment and Snipcart integration

In the test environment, `caddy` server is used to reverse proxy the app port (8041) to a subdomain of the main website.

example Caddyfile:
```
pay.example.com {
reverse_proxy 127.0.0.1:8041
}
```

In the payment methods request URL field of the [snipcart dashboard](https://app.snipcart.com/dashboard/account/gateway/customgateway) the following endpoint is specified:

```
https://pay.example.com/paywithskycoin
```

When placing an order; after the customer enters their shipping information and selects a shipping option, snipcart makes a POST request to the endpoint above, specified in the merchant dashboard. After verifying the request, a response is sent which is an array of payment options (an array of 1 but it can be more than one).

The array of payment option is then displayed for the customer, the previously configured ones in the merchant dashboard, as well as any which are specified in main.go, for this example only skycoin is shown.

To display the correct addresses for your webstore, these addresses must be generated and defined in addresses.txt in the current working directory.

**NOTE: Do not have the wallet with the coins in the same environment or on the same machine as this for obvious security reasons**

Create the wallet addresses in a secure environment (using the wallet gui is most functional), create 100 addresses and export them to a file:
```
skycoin-cli listWallets
skycoin-cli listAddresses 2021_04_20_7ba7.wlt > addresses.txt
```

Save these addresses somewhere in case you need to manually recover them.

Copy them to this repository in your test environment.
